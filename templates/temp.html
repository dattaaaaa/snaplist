{% extends "base.html" %}

{% block content %}
<style>
    /* Custom CSS */
    .btn-primary {
        @apply inline-flex items-center bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 transition-colors duration-200 ease-in-out;
    }
    
    .btn-secondary {
        @apply inline-flex items-center bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700 transition-colors duration-200 ease-in-out;
    }
    
    .product-card {
        @apply bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-200 ease-in-out;
        height: 450px; /* Fixed height for all cards */
        display: flex;
        flex-direction: column;
    }
    
    .product-image-container {
        height: 250px; /* Fixed height for image container */
        overflow: hidden;
        position: relative;
    }
    
    .product-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .product-details {
        @apply p-4 flex-1 flex flex-col justify-between;
    }

    .quantity-selector {
        @apply flex items-center justify-between bg-gray-50 rounded-lg p-2 mt-2;
    }

    .quantity-btn {
        @apply w-8 h-8 flex items-center justify-center rounded-full text-indigo-600 hover:bg-indigo-100 transition-colors duration-200;
    }

    .quantity-input {
        @apply w-12 text-center bg-transparent font-medium;
    }

    .add-to-cart {
        @apply w-full flex items-center justify-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors;
    }
</style>

<div class="container mx-auto px-4 py-8">
    <!-- Category Header -->
    <div class="mb-8">
        <nav class="mb-4">
            <a href="{{ url_for('home') }}" class="text-indigo-600 hover:text-indigo-800">Home</a>
            <span class="mx-2">/</span>
            <span class="text-gray-600">
                {% if category == 'fruits_vegetables' %}
                    Fruits & Vegetables
                {% else %}
                    Essentials
                {% endif %}
            </span>
        </nav>
        
        <h1 class="text-4xl font-bold mb-4">
            {% if category == 'fruits_vegetables' %}
                Fruits & Vegetables
            {% else %}
                Essentials
            {% endif %}
        </h1>
        
        <!-- Upload Section remains the same -->
    </div>

    <!-- Products Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {% for id, product in products.items() %}
        <div class="product-card" data-product-id="{{ id }}">
            <div class="product-image-container">
                <img src="{{ product.image }}" 
                     alt="{{ product.description }}" 
                     class="product-image"
                     onerror="this.src='/static/images/placeholder.jpg'">
            </div>
            <div class="product-details">
                <div>
                    <h3 class="font-semibold text-lg">{{ product.description }}</h3>
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-gray-600">â‚¹{{ product.price }} {{ product.unit }}</p>
                        <span class="text-sm text-gray-500">{{ product.category }}</span>
                    </div>
                </div>
                <div class="mt-auto">
                    <div class="quantity-selector" style="display: none;">
                        <button class="quantity-btn decrease-btn" onclick="updateQuantity('{{ id }}', 'decrease')">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" class="quantity-input" value="0" min="0" max="99" 
                               onchange="updateQuantity('{{ id }}', 'set', this.value)"
                               data-product-id="{{ id }}">
                        <button class="quantity-btn increase-btn" onclick="updateQuantity('{{ id }}', 'increase')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <button class="add-to-cart" onclick="addInitialToCart('{{ id }}', '{{ category }}')">
                        <i class="fas fa-shopping-cart"></i>
                        Add to Cart
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Rest of the template remains the same -->
</div>
{% endblock %}

{% block scripts %}
<script>
    // Existing camera and upload related code remains the same

    function addInitialToCart(productId, category) {
        const card = document.querySelector(`[data-product-id="${productId}"]`);
        const quantitySelector = card.querySelector('.quantity-selector');
        const addToCartBtn = card.querySelector('.add-to-cart');
        const quantityInput = card.querySelector('.quantity-input');

        quantitySelector.style.display = 'flex';
        addToCartBtn.style.display = 'none';
        
        updateQuantity(productId, 'set', 1, category);
    }

    function updateQuantity(productId, action, value, category) {
        const card = document.querySelector(`[data-product-id="${productId}"]`);
        const input = card.querySelector('.quantity-input');
        const addToCartBtn = card.querySelector('.add-to-cart');
        const quantitySelector = card.querySelector('.quantity-selector');
        
        let newQuantity = parseInt(input.value);
        
        switch(action) {
            case 'increase':
                newQuantity = Math.min(newQuantity + 1, 99);
                break;
            case 'decrease':
                newQuantity = Math.max(newQuantity - 1, 0);
                break;
            case 'set':
                newQuantity = Math.max(0, Math.min(parseInt(value), 99));
                break;
        }
        
        input.value = newQuantity;
        
        if (newQuantity === 0) {
            quantitySelector.style.display = 'none';
            addToCartBtn.style.display = 'flex';
        }

        // Update cart in backend
        fetch('/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                product: productId,
                quantity: newQuantity,
                category: category
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showNotification(data.error, 'error');
            } else {
                updateCartCount(data.cart_total);
            }
        })
        .catch(error => {
            showNotification('Error updating cart', 'error');
            console.error('Error:', error);
        });
    }

    function updateCartCount(count) {
        const cartCount = document.getElementById('cart-count');
        if (cartCount) {
            cartCount.textContent = count;
            cartCount.style.display = count > 0 ? 'block' : 'none';
        }
    }

    // Rest of the existing code remains the same
    




function updateQuantity(productId, action, value, category) {
    const card = document.querySelector(`[data-product-id="${productId}"]`);
    const input = card.querySelector('.quantity-input');
    const addToCartBtn = card.querySelector('.add-to-cart');
    const quantitySelector = card.querySelector('.quantity-selector');
    
    let newQuantity = parseInt(input.value);
    
    switch(action) {
        case 'increase':
            newQuantity = Math.min(newQuantity + 1, 99);
            break;
        case 'decrease':
            newQuantity = Math.max(newQuantity - 1, 0);
            break;
        case 'set':
            newQuantity = Math.max(0, Math.min(parseInt(value), 99));
            break;
    }
    
    input.value = newQuantity;
    
    if (newQuantity === 0) {
        quantitySelector.style.display = 'none';
        addToCartBtn.style.display = 'flex';
    }

    // Get current category from URL
    const currentCategory = window.location.pathname.split('/').pop();

    // Update cart in backend
    fetch('/cart/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            product: productId,
            quantity: newQuantity,
            category: currentCategory
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification(data.error, 'error');
        } else {
            showNotification('Cart updated successfully', 'success');
            updateCartCount(data.cart_total);
        }
    })
    .catch(error => {
        showNotification('Error updating cart', 'error');
        console.error('Error:', error);
    });
}

function addInitialToCart(productId) {
    const card = document.querySelector(`[data-product-id="${productId}"]`);
    const quantitySelector = card.querySelector('.quantity-selector');
    const addToCartBtn = card.querySelector('.add-to-cart');
    const quantityInput = card.querySelector('.quantity-input');
    const currentCategory = window.location.pathname.split('/').pop();

    quantitySelector.style.display = 'flex';
    addToCartBtn.style.display = 'none';
    quantityInput.value = 1;
    
    // Update cart in backend
    fetch('/cart/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            product: productId,
            quantity: 1,
            category: currentCategory
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification(data.error, 'error');
            // Reset UI if error
            quantitySelector.style.display = 'none';
            addToCartBtn.style.display = 'flex';
        } else {
            showNotification('Added to cart', 'success');
            updateCartCount(data.cart_total);
        }
    })
    .catch(error => {
        showNotification('Error adding to cart', 'error');
        console.error('Error:', error);
        // Reset UI if error
        quantitySelector.style.display = 'none';
        addToCartBtn.style.display = 'flex';
    });
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 bg-white rounded-lg shadow-lg border-l-4 
        ${type === 'success' ? 'border-green-500' : 'border-red-500'} 
        transform transition-all duration-300 ease-out`;
    
    notification.innerHTML = `
        <div class="p-4">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle 
                       text-${type === 'success' ? 'green' : 'red'}-500"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900">${message}</p>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}