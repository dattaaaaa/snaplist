{% extends "base.html" %}
{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 to-indigo-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white/5 backdrop-blur-lg rounded-2xl shadow-2xl overflow-hidden border border-white/10">
            <!-- Chat Header -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 border-b border-white/10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="h-12 w-12 rounded-full bg-white/10 backdrop-blur-sm flex items-center justify-center shadow-lg">
                            <i class="fas fa-robot text-white text-2xl"></i>
                        </div>
                        <div>
                            <h2 class="text-white font-bold text-xl">Genius Assistant</h2>
                            <p class="text-indigo-100 text-sm">Powered by Quantum AI</p>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button id="clearChat" class="p-2 rounded-full hover:bg-white/10 transition-all duration-300 group">
                            <i class="fas fa-trash text-white/60 group-hover:text-white text-lg"></i>
                        </button>
                        <button id="toggleChat" class="p-2 rounded-full hover:bg-white/10 transition-all duration-300 group">
                            <i class="fas fa-times text-white/60 group-hover:text-white text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="flex-1 overflow-y-auto p-6 space-y-4" id="chatMessages" style="height: 500px;">
                <!-- Welcome Message -->
                <div class="flex items-start animate-float-in">
                    <div class="flex-shrink-0">
                        <div class="h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-500 flex items-center justify-center shadow-md">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                    </div>
                    <div class="ml-3 bg-white/10 backdrop-blur-sm rounded-2xl py-3 px-4 max-w-[80%] shadow-lg">
                        <p class="text-sm text-white/90">
                            ðŸŒŸ Hello! I'm your AI shopping companion. I can help you with:
                            <ul class="list-disc ml-4 mt-2 space-y-1 text-white/80">
                                <li>ðŸšš Real-time order tracking</li>
                                <li>ðŸ“¦ Product details & comparisons</li>
                                <li>ðŸ”„ Returns & refunds assistance</li>
                                <li>ðŸŽ¯ Personalized recommendations</li>
                            </ul>
                            <div class="mt-3 text-blue-200/90">How may I assist you today?</div>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="border-t border-white/10 px-6 py-4 bg-white/5">
                <form id="chatForm" class="flex items-center space-x-4">
                    <div class="flex-1 relative">
                        <input type="text" 
                               id="messageInput" 
                               class="w-full bg-white/5 backdrop-blur-sm border border-white/10 rounded-xl px-4 py-3 pr-12 text-white/90 placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300"
                               placeholder="Ask me anything...">
                        <button type="button" id="attachButton" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/50 hover:text-blue-400 transition-colors duration-300">
                            <i class="fas fa-magic text-lg"></i>
                        </button>
                    </div>
                    <button type="submit" 
                            class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-xl px-6 py-3 hover:scale-105 transform transition-all duration-300 shadow-lg hover:shadow-xl active:scale-95">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const clearChatBtn = document.getElementById('clearChat');
    let isTyping = false;

    // Clear chat functionality
    clearChatBtn.addEventListener('click', function() {
        chatMessages.querySelectorAll('.message-container').forEach(msg => msg.remove());
        // Optional: Add API call to clear backend history
    });

    // Load chat history
    fetch('/chat/history')
        .then(response => response.json())
        .then(data => {
            if (data.messages) {
                data.messages.reverse().forEach(message => {
                    appendMessage(message.content, message.role === 'assistant');
                });
                scrollToBottom();
            }
        });

    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;

        messageInput.value = '';
        appendMessage(message, false);
        scrollToBottom();
        showTypingIndicator();

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();
            hideTypingIndicator();

            if (data.error) {
                appendMessage('ðŸš¨ Oops! Neural network overload. Try again?', true);
            } else {
                appendMessage(data.response, true);
            }
            
            scrollToBottom();
        } catch (error) {
            console.error('Error:', error);
            hideTypingIndicator();
            appendMessage('ðŸŒŒ Connection to quantum server failed...', true);
            scrollToBottom();
        }
    });

    function appendMessage(content, isBot) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex items-start ${isBot ? '' : 'justify-end'} message-container animate-float-in`;
        
        const innerHTML = isBot ? `
            <div class="flex-shrink-0">
                <div class="h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-500 flex items-center justify-center shadow-md">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
            </div>
            <div class="ml-3 bg-white/10 backdrop-blur-sm rounded-2xl py-3 px-4 max-w-[80%] shadow-lg">
                <p class="text-sm text-white/90">${content}</p>
                <div class="mt-1 text-xs text-white/50">${new Date().toLocaleTimeString()}</div>
            </div>
        ` : `
            <div class="mr-3 bg-gradient-to-l from-blue-600 to-indigo-600 rounded-2xl py-3 px-4 max-w-[80%] shadow-lg">
                <p class="text-sm text-white/90">${content}</p>
                <div class="mt-1 text-xs text-white/50 text-right">${new Date().toLocaleTimeString()}</div>
            </div>
            <div class="flex-shrink-0">
                <div class="h-10 w-10 rounded-full bg-white/10 backdrop-blur-sm flex items-center justify-center shadow-md">
                    <i class="fas fa-user-astronaut text-white text-sm"></i>
                </div>
            </div>
        `;
        
        messageDiv.innerHTML = innerHTML;
        chatMessages.appendChild(messageDiv);
    }

    function showTypingIndicator() {
        if (!isTyping) {
            isTyping = true;
            const indicatorDiv = document.createElement('div');
            indicatorDiv.id = 'typingIndicator';
            indicatorDiv.className = 'flex items-start animate-pulse';
            indicatorDiv.innerHTML = `
                <div class="flex-shrink-0">
                    <div class="h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-500 flex items-center justify-center shadow-md">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                </div>
                <div class="ml-3 bg-white/10 backdrop-blur-sm rounded-2xl py-2 px-4">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(indicatorDiv);
            scrollToBottom();
        }
    }

    function hideTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
            indicator.remove();
            isTyping = false;
        }
    }

    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
});
</script>

<style>
@keyframes float-in {
    0% { opacity: 0; transform: translateY(20px) scale(0.95); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}

.animate-float-in {
    animation: float-in 0.4s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
}

.typing-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 0;
}

.typing-indicator span {
    width: 8px;
    height: 8px;
    background: linear-gradient(to right, #60a5fa, #818cf8);
    border-radius: 50%;
    animation: typing-bounce 1.2s infinite ease-in-out;
}

@keyframes typing-bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-8px); }
}

#chatMessages::-webkit-scrollbar {
    width: 8px;
    background: transparent;
}

#chatMessages::-webkit-scrollbar-thumb {
    background: linear-gradient(to bottom, #3b82f6, #6366f1);
    border-radius: 4px;
}

#chatMessages::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
}

.message-container:last-child {
    margin-bottom: 1rem;
}

.hover\:scale-105:hover {
    transform: scale(1.05);
}
</style>
{% endblock %}