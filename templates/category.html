{% extends "base.html" %}

{% block content %}
<style>
    /* Custom CSS */
    .btn-primary {
        @apply inline-flex items-center bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 transition-colors duration-200 ease-in-out;
    }
    
    .btn-secondary {
        @apply inline-flex items-center bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700 transition-colors duration-200 ease-in-out;
    }
    
    .product-card {
        @apply bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-200 ease-in-out;
        height: 450px; /* Fixed height for all cards */
        display: flex;
        flex-direction: column;
    }
    
    .product-image-container {
        height: 250px; /* Fixed height for image container */
        overflow: hidden;
        position: relative;
    }
    
    .product-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .product-details {
        @apply p-4 flex-1 flex flex-col justify-between;
    }

    .quantity-selector {
        @apply flex items-center justify-between bg-gray-50 rounded-lg p-2 mt-2;
    }

    .quantity-btn {
        @apply w-8 h-8 flex items-center justify-center rounded-full text-indigo-600 hover:bg-indigo-100 transition-colors duration-200;
    }

    .quantity-input {
        @apply w-12 text-center bg-transparent font-medium;
    }

    .add-to-cart {
        @apply w-full flex items-center justify-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors;
    }
    .search-filter-section {
        @apply bg-white rounded-xl shadow-md p-6 mb-8;
    }
    
    .search-input {
        @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500;
    }
    
    .filter-group {
        @apply mt-6;
    }
    
    .filter-title {
        @apply text-lg font-semibold mb-3;
    }
    
    .filter-option {
        @apply flex items-center gap-2 mb-2;
    }
    
    .filter-checkbox {
        @apply w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500;
    }
    
    .price-range-select {
        @apply w-full px-3 py-2 border border-gray-300 rounded-md;
    }
</style>

<div class="container mx-auto px-4 py-8">
    <!-- Category Header -->
    <div class="mb-8">
        <nav class="mb-4">
            <a href="{{ url_for('home') }}" class="text-indigo-600 hover:text-indigo-800">Home</a>
            <span class="mx-2">/</span>
            <span class="text-gray-600">
                {% if category == 'fruits_vegetables' %}
                    Fruits & Vegetables
                {% else %}
                    Essentials
                {% endif %}
            </span>
        </nav>
        
        <h1 class="text-4xl font-bold mb-4">
            {% if category == 'fruits_vegetables' %}
                Fruits & Vegetables
            {% else %}
                Essentials
            {% endif %}
        </h1>
        
        <!-- Upload Section -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="mb-4 md:mb-0">
                    <h2 class="text-xl font-semibold">Quick Add with AI</h2>
                    <p class="text-gray-600">Take a photo or upload an image to detect items</p>
                </div>
                <div class="flex gap-4">
                    <button id="camera-button" class="btn-primary">
                        <i class="fas fa-camera mr-2"></i>Camera
                    </button>
                    <button id="upload-button" class="btn-secondary">
                        <i class="fas fa-upload mr-2"></i>Upload
                    </button>
                </div>
            </div>
            
            <!-- Drag & Drop Area -->
            <div id="upload-area" class="mt-6 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                <input type="file" id="image-input" class="hidden" accept="image/*">
                <div class="space-y-2">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400"></i>
                    <p class="text-gray-500">Drag and drop your image here or click to select</p>
                    <p class="text-sm text-gray-400">Supports JPG, JPEG, PNG</p>
                </div>
            </div>
        </div>
    </div>
    <div class="search-filter-section">
        <!-- Search Bar -->
        <div class="relative">
            <input type="text" 
                   id="search-input" 
                   placeholder="Search products..." 
                   class="search-input"
                   onkeyup="filterProducts()">
            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
            <!-- Category Filter -->
            <div class="filter-group">
                <h3 class="filter-title">Category</h3>
                <div class="filter-options">
                    {% if category == 'fruits_vegetables' %}
                        <label class="filter-option">
                            <input type="checkbox" 
                                   class="filter-checkbox category-filter" 
                                   value="fruits"
                                   onchange="filterProducts()">
                            Fruits
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" 
                                   class="filter-checkbox category-filter" 
                                   value="vegetables"
                                   onchange="filterProducts()">
                            Vegetables
                        </label>
                    {% else %}
                        <label class="filter-option">
                            <input type="checkbox" 
                                   class="filter-checkbox category-filter" 
                                   value="healthcare"
                                   onchange="filterProducts()">
                            Healthcare
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" 
                                   class="filter-checkbox category-filter" 
                                   value="personal_care"
                                   onchange="filterProducts()">
                            Personal Care
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" 
                                   class="filter-checkbox category-filter" 
                                   value="beverages"
                                   onchange="filterProducts()">
                            Beverages
                        </label>
                    {% endif %}
                </div>
            </div>

            <!-- Price Filter -->
            <div class="filter-group">
                <h3 class="filter-title">Price Range</h3>
                <select id="price-filter" class="price-range-select" onchange="filterProducts()">
                    <option value="all">All Prices</option>
                    <option value="0-100">Under ₹100</option>
                    <option value="100-200">₹100 - ₹200</option>
                    <option value="200-500">₹200 - ₹500</option>
                    <option value="500-1000">₹500+</option>
                </select>
            </div>

            <!-- Sorting -->
            <div class="filter-group">
                <h3 class="filter-title">Sort By</h3>
                <select id="sort-by" class="price-range-select" onchange="sortProducts()">
                    <option value="default">Default</option>
                    <option value="price_asc">Price: Low to High</option>
                    <option value="price_desc">Price: High to Low</option>
                    <option value="name_asc">Name: A to Z</option>
                    <option value="name_desc">Name: Z to A</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Products Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {% for id, product in products.items() %}
        <div class="product-card" data-product-id="{{ id }}">
            <div class="product-image-container">
                <img src="{{ product.image }}" 
                     alt="{{ product.description }}" 
                     class="product-image"
                     onerror="this.src='/static/images/placeholder.jpg'">
            </div>
            <div class="product-details">
                <div>
                    <h3 class="font-semibold text-lg">{{ product.description }}</h3>
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-gray-600">₹{{ product.price }} {{ product.unit }}</p>
                        <span class="text-sm text-gray-500">{{ product.category }}</span>
                    </div>
                </div>
                <div class="mt-auto">
                    <div class="quantity-selector" style="display: none;">
                        <button class="quantity-btn decrease-btn" onclick="updateQuantity('{{ id }}', 'decrease')">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" class="quantity-input" value="0" min="0" max="99" 
                               onchange="updateQuantity('{{ id }}', 'set', this.value)"
                               data-product-id="{{ id }}">
                        <button class="quantity-btn increase-btn" onclick="updateQuantity('{{ id }}', 'increase')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <button class="add-to-cart" onclick="addInitialToCart('{{ id }}', '{{ category }}')">
                        <i class="fas fa-shopping-cart"></i>
                        Add to Cart
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>


     <!-- Detection Results Modal -->
    <div id="detection-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Detected Items</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="detected-items" class="grid gap-4 max-h-[60vh] overflow-y-auto"></div>
            <div class="mt-6 flex justify-end gap-4">
                <button onclick="closeModal()" class="btn-secondary">
                    Close
                </button>
                <button onclick="addAllToCart()" class="btn-primary">
                    <i class="fas fa-shopping-cart mr-2"></i>
                    Add All to Cart
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600 mx-auto"></div>
            <p class="mt-4 text-lg">Processing your image...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // DOM Elements
    const uploadArea = document.getElementById('upload-area');
    const imageInput = document.getElementById('image-input');
    const cameraButton = document.getElementById('camera-button');
    const uploadButton = document.getElementById('upload-button');
    const loadingOverlay = document.getElementById('loading-overlay');
    const detectionModal = document.getElementById('detection-modal');
    const detectedItems = document.getElementById('detected-items');
    
    // Event Listeners
    uploadArea.addEventListener('click', () => imageInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) {
            processImage(file);
        }
    });

    imageInput.addEventListener('change', () => {
        const file = imageInput.files[0];
        if (file) {
            processImage(file);
        }
    });


    cameraButton.addEventListener('click', async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment'
                } 
            });
            
            // Create video element
            const video = document.createElement('video');
            video.srcObject = stream;
            
            // Create canvas for snapshot
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // Wait for video to be ready
            await new Promise(resolve => video.onloadedmetadata = resolve);
            video.play();
            
            // Set canvas size to video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Create modal for camera view
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="relative bg-white p-4 rounded-lg max-w-2xl w-full mx-4">
                    <div id="camera-feed" class="relative"></div>
                    <div class="mt-4 flex justify-end gap-4">
                        <button id="capture-btn" class="btn-primary">
                            <i class="fas fa-camera mr-2"></i>Capture
                        </button>
                        <button id="cancel-btn" class="btn-secondary">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('camera-feed').appendChild(video);
            
            // Handle capture
            document.getElementById('capture-btn').onclick = () => {
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                canvas.toBlob(blob => {
                    const file = new File([blob], "capture.jpg", { type: "image/jpeg" });
                    processImage(file);
                }, 'image/jpeg');
                
                // Clean up
                stream.getTracks().forEach(track => track.stop());
                modal.remove();
            };
            
            // Handle cancel
            document.getElementById('cancel-btn').onclick = () => {
                stream.getTracks().forEach(track => track.stop());
                modal.remove();
            };
            
        } catch (err) {
            console.error('Error accessing camera:', err);
            showNotification('Could not access camera. Please check permissions.', 'error');
            // Fallback to file input
            imageInput.removeAttribute('capture');
            imageInput.click();
        }
    });

    uploadButton.addEventListener('click', () => {
        imageInput.removeAttribute('capture');
        imageInput.click();
    });

    // Functions

    function filterProducts() {
        const searchQuery = document.getElementById('search-input').value.toLowerCase();
        const priceRange = document.getElementById('price-filter').value;
        const selectedCategories = Array.from(document.querySelectorAll('.category-filter:checked'))
                                      .map(checkbox => checkbox.value.toLowerCase());
        
        document.querySelectorAll('.product-card').forEach(card => {
            const productId = card.dataset.productId;
            const product = {
                name: card.querySelector('h3').textContent.toLowerCase(),
                price: parseFloat(card.querySelector('.text-gray-600').textContent.replace('₹', '')),
                category: card.querySelector('.text-gray-500').textContent.toLowerCase()
            };

            // Search filter
            const matchesSearch = product.name.includes(searchQuery);

            // Category filter
            const matchesCategory = selectedCategories.length === 0 || 
                                  selectedCategories.includes(product.category.replace(' ', '_'));

            // Price filter
            let matchesPrice = true;
            if (priceRange !== 'all') {
                const [min, max] = priceRange.split('-').map(Number);
                matchesPrice = product.price >= min && 
                             (max ? product.price <= max : true);
            }

            // Show/hide based on all filters
            card.style.display = (matchesSearch && matchesCategory && matchesPrice) ? 
                               'flex' : 'none';
        });
    }

    function sortProducts() {
        const sortBy = document.getElementById('sort-by').value;
        const container = document.querySelector('.grid');
        const cards = Array.from(container.querySelectorAll('.product-card'));

        cards.sort((a, b) => {
            const aPrice = parseFloat(a.querySelector('.text-gray-600').textContent.replace('₹', ''));
            const bPrice = parseFloat(b.querySelector('.text-gray-600').textContent.replace('₹', ''));
            const aName = a.querySelector('h3').textContent.toLowerCase();
            const bName = b.querySelector('h3').textContent.toLowerCase();

            switch(sortBy) {
                case 'price_asc': return aPrice - bPrice;
                case 'price_desc': return bPrice - aPrice;
                case 'name_asc': return aName.localeCompare(bName);
                case 'name_desc': return bName.localeCompare(aName);
                default: return 0;
            }
        });

        // Re-insert sorted cards
        cards.forEach(card => container.appendChild(card));
    }


    function processImage(file) {
        loadingOverlay.style.display = 'flex';
        const formData = new FormData();
        formData.append('image', file);

        fetch('/upload/{{ category }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showNotification(data.error, 'error');
            } else {
                displayResults(data.items);
            }
        })
        .catch(error => {
            showNotification('An error occurred while processing the image', 'error');
            console.error('Error:', error);
        })
        .finally(() => {
            loadingOverlay.style.display = 'none';
        });
    }

    function displayResults(items) {
    detectedItems.innerHTML = '';
    items.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'bg-gray-50 p-4 rounded-lg flex items-center gap-4';
        
        // Format the label to match the product database keys
        const formattedLabel = item.label.toLowerCase().trim();
        
        itemElement.innerHTML = `
            <img src="${item.image}" 
                 alt="${item.description}" 
                 class="w-20 h-20 object-cover rounded"
                 onerror="this.src='https://via.placeholder.com/80?text=Product'">
            <div class="flex-grow">
                <h3 class="font-semibold">${formatLabel(item.label)}</h3>
                <p class="text-gray-600">₹${item.price} ${item.unit}</p>
                <p class="text-sm text-gray-500">Confidence: ${(item.confidence * 100).toFixed(1)}%</p>
            </div>
            <button onclick="addToCart('${formattedLabel}', 1)" class="btn-primary">
                <i class="fas fa-plus mr-2"></i>Add
            </button>
        `;
        detectedItems.appendChild(itemElement);
    });
    detectionModal.style.display = 'flex';
    filterProducts();
}

    function formatLabel(label) {
        return label
            .split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }

    function addInitialToCart(productId) {
        const card = document.querySelector(`[data-product-id="${productId}"]`);
        const quantitySelector = card.querySelector('.quantity-selector');
        const addToCartBtn = card.querySelector('.add-to-cart');
        const quantityInput = card.querySelector('.quantity-input');
        const currentCategory = window.location.pathname.split('/').pop();

        quantitySelector.style.display = 'flex';
        addToCartBtn.style.display = 'none';
        quantityInput.value = 1;
        
        // Update cart in backend
        fetch('/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                product: productId,
                quantity: 1,
                category: currentCategory
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showNotification(data.error, 'error');
                // Reset UI if error
                quantitySelector.style.display = 'none';
                addToCartBtn.style.display = 'flex';
            } else {
                showNotification('Added to cart', 'success');
                updateCartCount(data.cart_total);
            }
        })
        .catch(error => {
            showNotification('Error adding to cart', 'error');
            console.error('Error:', error);
            // Reset UI if error
            quantitySelector.style.display = 'none';
            addToCartBtn.style.display = 'flex';
        });
    }
    function updateQuantity(productId, action, value, category) {
        const card = document.querySelector(`[data-product-id="${productId}"]`);
        const input = card.querySelector('.quantity-input');
        const addToCartBtn = card.querySelector('.add-to-cart');
        const quantitySelector = card.querySelector('.quantity-selector');
        
        let newQuantity = parseInt(input.value);
        
        switch(action) {
            case 'increase':
                newQuantity = Math.min(newQuantity + 1, 99);
                break;
            case 'decrease':
                newQuantity = Math.max(newQuantity - 1, 0);
                break;
            case 'set':
                newQuantity = Math.max(0, Math.min(parseInt(value), 99));
                break;
        }
        
        input.value = newQuantity;
        
        if (newQuantity === 0) {
            quantitySelector.style.display = 'none';
            addToCartBtn.style.display = 'flex';
        }

        // Get current category from URL
        const currentCategory = window.location.pathname.split('/').pop();

        // Update cart in backend
        fetch('/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                product: productId,
                quantity: newQuantity,
                category: currentCategory
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showNotification(data.error, 'error');
            } else {
                showNotification('Cart updated successfully', 'success');
                updateCartCount(data.cart_total);
            }
        })
        .catch(error => {
            showNotification('Error updating cart', 'error');
            console.error('Error:', error);
        });
    }

    function updateCartCount(count) {
        const cartCount = document.getElementById('cart-count');
        if (cartCount) {
            cartCount.textContent = count;
            cartCount.style.display = count > 0 ? 'block' : 'none';
        }
    }

    
    function addToCart(product, quantity) {
    const currentCategory = window.location.pathname.split('/').pop();
    
    fetch('/cart/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
            product: product,
            quantity: quantity,
            category: currentCategory
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification(data.error, 'error');
        } else {
            showNotification('Item added to cart', 'success');
            updateCartCount(data.cart_total);
        }
    })
    .catch(error => {
        showNotification('An error occurred while adding to cart', 'error');
        console.error('Error:', error);
    });
}
    function addAllToCart() {
    const items = document.querySelectorAll('#detected-items > div');
    let promises = [];
    const currentCategory = window.location.pathname.split('/').pop(); // Get current category from URL
    
    items.forEach(item => {
        const label = item.querySelector('h3').textContent.toLowerCase().replace(/ /g, '_');
        promises.push(
            fetch('/cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    product: label,
                    quantity: 1,
                    category: currentCategory 
                })
            })
        );
    });

    Promise.all(promises)
        .then(() => {
            showNotification('All items added to cart', 'success');
            updateCartCount();
            closeModal();
        })
        .catch(error => {
            showNotification('An error occurred while adding items', 'error');
            console.error('Error:', error);
        });
}


    function closeModal() {
        detectionModal.style.display = 'none';
    }
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `fixed bottom-4 right-4 bg-white rounded-lg shadow-lg border-l-4 
            ${type === 'success' ? 'border-green-500' : 'border-red-500'} 
            transform transition-all duration-300 ease-out`;
        
        notification.innerHTML = `
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle 
                        text-${type === 'success' ? 'green' : 'red'}-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-900">${message}</p>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
}


    function updateCartCount() {
    fetch('/cart')
        .then(response => response.json())
        .then(data => {
            const cartCount = document.getElementById('cart-count');
            if (cartCount) {
                const count = data.cart_total || 0;
                cartCount.textContent = count;
                cartCount.style.display = count > 0 ? 'block' : 'none';
            }
        })
        .catch(error => console.error('Error updating cart count:', error));
}

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target === detectionModal) {
            closeModal();
        }
    }

    // Initialize
    updateCartCount();
</script>
{% endblock %}